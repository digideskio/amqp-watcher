#!/usr/bin/env node

var amqpWatcher = require('../lib'),
	comm = require('commander'),
	url = require('url'),
	util = require('util');

function list(val) {
	return val.split(':');
}

comm
	.version('0.0.1')
	.option('-s, --server <servername>', 'Hostname of the server [localhost]', 'localhost')
	.option('-u, --url <url>', 'Url to connect to. For example amqp://user:pass@localhost:port/vhost]', 'amqp://localhost')

	.option('-e, --exchange <name:type:durable>', 'Exchange type to bind to [amq.topic:topic:true]', list)
	.option('-b, --body <text>', 'Send a message with the specified body. Will quit after')
	.option('-k, --key [routing key]', 'Set the value of the routing key [#]', '#')
	.option('-c, --count <n>', 'Repeat the msg n times [1]', 1)
	.parse(process.argv);

//Default values
comm.listen = comm.listen && '#';
comm.exchange = comm.exchange || [];
comm.durable = comm.exchange[2] == 'true';
comm.url = url.parse(comm.url.replace('localhost', comm.server));

//Exchange options
comm.exchange = {
	name: comm.exchange[0],
	options: {type: comm.exchange[1], durable: comm.durable}
}

amqpWatcher.create(comm).connect(function(err, w) {

	if (err) throw new Error(err);

	if (comm.body) {

		console.log('Sending %d messages:', comm.count);
		
		w.exchange.on('open', function() { w.conn.end(); });

		console.time('took');
		
		for (var i=0; i<comm.count; i++) {
			w.exchange.publish(comm.key, comm.body);
			util.print('.');
		}
		console.log();
		console.timeEnd('took');
		return;
	}
	
	var qName = 'watcher-' + Math.random() * 999999;
	var q = w.conn.queue(qName, {exclusive: true}, function() {
		q.bind(w.exchange, comm.key);
		console.log('Watching...');
		q.subscribe(function(msg) {
			util.log(msg.data);
		})
	})	
});